---
- name: Pre-provisioning tasks
  hosts: localhost
  sudo: no
  tasks:
    - name: Group by provisioner type
      group_by: key={{ provisioner.type }}

    - name: Add the host to the inventory
      add_host:
        name="host0"
        groups="provisioned"
        ansible_fqdn="{{ provisioner.host0.fqdn }}"
        ansible_ssh_host="{{ provisioner.host0.fqdn }}"
        ansible_ssh_user="{{ provisioner.host0.ssh_user }}"
        ansible_ssh_pass="{{ provisioner.host0.ssh_key }}"

- name: Use beaker to provision the machine
  hosts: localhost
  tasks:
    - name: Provision machine using the 'beaker_provisioner' module
      beaker_provisioner:
          server_url: "{{ provisioner.host0.server_url }}"
          fqdn: "{{ hostvars[inventory_hostname].ansible_fqdn }}"
          username: "{{ hostvars[inventory_hostname].ansible_ssh_user }}"
          password: "{{ hostvars[inventory_hostname].ansible_ssh_pass }}"
          action: "{{ provisioner.hosts.host0.action }}"
          distro_tree_id: "{{ provisioner.hosts.host0.distro_tree_id }}"
